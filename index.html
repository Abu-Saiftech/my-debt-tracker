<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Step-by-Step Wealth Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #4cafef; --success: #66bb6a; --danger: #ef5350; --bg: #f0f2f5; --dark: #2c3e50; --warning: #ffa726; }
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: var(--bg); color: #333; }
    .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .net-worth-card { text-align: center; background: var(--dark); color: white; }
    .net-worth-amount { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }
    
    .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 850px) { .grid-container { grid-template-columns: 1fr; } }
    
    .item-row { border-bottom: 1px solid #eee; padding: 15px 0; }
    .item-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; margin-bottom: 8px; }
    
    .progress { background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden; margin-bottom: 10px; }
    .bar { height: 100%; transition: width 0.5s; }
    
    input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px; width: 100%; box-sizing: border-box; font-size: 0.9rem; }
    button { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
    
    .btn-main { background: var(--dark); color: white; width: 100%; margin-top: 5px; }
    .btn-action { background: #eee; color: #333; font-size: 0.75rem; margin-right: 5px; margin-bottom: 5px; }
    .btn-delete { color: var(--danger); background: none; font-size: 1.2rem; float: right; }
    
    .panel { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-top: 10px; display: none; border: 1px solid #eee; }
    .show { display: block; }
    
    .due-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    .due-soon { background: #fff3e0; color: #e65100; }
    .due-late { background: #ffebee; color: #c62828; }
    
    .log-container { max-height: 250px; overflow-y: auto; font-size: 0.85rem; }
    
    /* Chart Container Style */
    .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 20px; }
  </style>
</head>
<body>

  <div class="card net-worth-card">
    <h2>Financial Dashboard</h2>
    <div id="netWorthDisplay" class="net-worth-amount">$0</div>
    <p id="syncStatus">‚òÅÔ∏è Syncing...</p>
  </div>

  <div class="grid-container">
    <div class="card">
      <h2 style="color: var(--success)">üí∞ Step 1: Add Savings</h2>
      <input type="text" id="savName" placeholder="Account Name">
      <input type="number" id="savVal" placeholder="Current Balance">
      <button class="btn-main" onclick="addItem('savings')" style="background: var(--success)">Create Account</button>
      <div id="savingsList"></div>
    </div>

    <div class="card">
      <h2 style="color: var(--danger)">üí≥ Step 1: Add Debt</h2>
      <input type="text" id="debtName" placeholder="Debt Name">
      <input type="number" id="debtTotal" placeholder="Total Owed">
      <label style="font-size: 0.8rem; color: #666;">Due Date:</label>
      <input type="date" id="debtDueDate">
      <button class="btn-main" onclick="addItem('debts')" style="background: var(--danger)">Create Debt Tracker</button>
      
      <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
      
      <div class="chart-container">
        <canvas id="debtChart"></canvas>
      </div>

      <div id="debtList"></div>
    </div>
  </div>

  <div class="card">
    <h2>üìú History & Notes</h2>
    <div id="logContainer" class="log-container"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC1BeYYPsIskQBgcNQqrp68W4Sx_Yzyj14",
      authDomain: "dept-dash-14efd.firebaseapp.com",
      databaseURL: "https://dept-dash-14efd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dept-dash-14efd",
      storageBucket: "dept-dash-14efd.firebasestorage.app",
      messagingSenderId: "109771929198",
      appId: "1:109771929198:web:73cbebbeb1305edd6e587f",
      measurementId: "G-QWJFJ6MQL2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const financeRef = ref(db, 'financeData');

    let data = { debts: [], savings: [], history: [] };
    let myChart = null; // Variable to store chart instance

    onValue(financeRef, (snapshot) => {
      const d = snapshot.val();
      if (d) {
        data = d;
        if (!data.debts) data.debts = [];
        if (!data.savings) data.savings = [];
        if (!data.history) data.history = [];
        render();
        document.getElementById('syncStatus').innerText = "‚úÖ Cloud Synced";
      }
    });

    window.addItem = function(t) {
      if (t === 'savings') {
        const n = document.getElementById('savName').value;
        const b = parseFloat(document.getElementById('savVal').value) || 0;
        if(n) data.savings.push({ name: n, bal: b });
      } else {
        const n = document.getElementById('debtName').value;
        const tt = parseFloat(document.getElementById('debtTotal').value) || 0;
        const dd = document.getElementById('debtDueDate').value || "";
        if(n) data.debts.push({ name: n, total: tt, paid: 0, dueDate: dd });
      }
      save();
      if(t==='savings') { document.getElementById('savName').value = ''; document.getElementById('savVal').value = ''; }
      else { document.getElementById('debtName').value = ''; document.getElementById('debtTotal').value = ''; document.getElementById('debtDueDate').value = ''; }
    };

    window.submitUpdate = function(type, index) {
      const amt = parseFloat(document.getElementById(`${type === 'debts' ? 'd' : 's'}Amt-${index}`).value);
      const date = document.getElementById(`${type === 'debts' ? 'd' : 's'}Date-${index}`).value || new Date().toLocaleDateString();
      const note = document.getElementById(`${type === 'debts' ? 'd' : 's'}Note-${index}`).value || "";
      if(isNaN(amt)) return;
      if(type === 'debts') data.debts[index].paid += amt;
      else data.savings[index].bal += amt;
      data.history.unshift({ date, name: (type === 'debts' ? data.debts[index].name : data.savings[index].name), amount: amt, note });
      save();
    };

    window.editDebtInfo = function(index) {
      const newTotal = parseFloat(document.getElementById(`editTotal-${index}`).value);
      const newDate = document.getElementById(`editDate-${index}`).value;
      data.debts[index].total = newTotal;
      data.debts[index].dueDate = newDate;
      save();
    };

    window.toggle = (id) => document.getElementById(id).classList.toggle('show');
    window.deleteItem = (t, i) => { if(confirm("Delete?")) { data[t].splice(i, 1); save(); } };
    function save() { set(financeRef, data); }

    function getDueStatus(dateStr) {
      if(!dateStr) return "";
      const diff = Math.ceil((new Date(dateStr) - new Date()) / (1000 * 60 * 60 * 24));
      if (diff < 0) return `<span class="due-tag due-late">Overdue: ${Math.abs(diff)}d</span>`;
      if (diff <= 7) return `<span class="due-tag due-soon">Soon: ${diff}d</span>`;
      return `<span class="due-tag" style="background:#e8f5e9; color:#2e7d32">${dateStr}</span>`;
    }

    // --- CHART UPDATE FUNCTION ---
    function updateDebtChart(debts) {
      const ctx = document.getElementById('debtChart').getContext('2d');
      const labels = debts.map(d => d.name);
      const balances = debts.map(d => (d.total - d.paid));

      if (myChart) { myChart.destroy(); } // Refresh chart if it exists

      if (balances.length === 0) return;

      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: balances,
            backgroundColor: ['#ef5350', '#ffa726', '#ba68c8', '#4cafef', '#90a4ae', '#ffd54f'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
          }
        }
      });
    }

    function render() {
      const sList = document.getElementById('savingsList');
      const dList = document.getElementById('debtList');
      const lList = document.getElementById('logContainer');
      sList.innerHTML = ''; dList.innerHTML = ''; lList.innerHTML = '';
      let ts = 0, td = 0;

      data.savings.forEach((s, i) => {
        ts += s.bal;
        sList.innerHTML += `
          <div class="item-row">
            <div class="item-header"><span>${s.name}</span><span>$${s.bal.toLocaleString()}</span></div>
            <button class="btn-action" onclick="toggle('sUpdate-${i}')">Update Balance</button>
            <button class="btn-delete" onclick="deleteItem('savings', ${i})">&times;</button>
            <div id="sUpdate-${i}" class="panel">
              <input type="number" id="sAmt-${i}" placeholder="Amount (+/-)">
              <input type="date" id="sDate-${i}">
              <input type="text" id="sNote-${i}" placeholder="Note">
              <button class="btn-main" onclick="submitUpdate('savings', ${i})" style="background:var(--success)">Save</button>
            </div>
          </div>`;
      });

      const sortedDebts = [...data.debts].map((d, originalIndex) => ({...d, originalIndex}))
        .sort((a, b) => {
          if (!a.dueDate) return 1;
          if (!b.dueDate) return -1;
          return new Date(a.dueDate) - new Date(b.dueDate);
        });

      sortedDebts.forEach((d) => {
        const rem = d.total - d.paid; td += rem;
        const p = (d.paid / d.total) * 100 || 0;
        const i = d.originalIndex;
        dList.innerHTML += `
          <div class="item-row">
            <div class="item-header"><span>${d.name} ${getDueStatus(d.dueDate)}</span><span>$${rem.toLocaleString()} left</span></div>
            <div class="progress"><div class="bar" style="width:${p}%; background:var(--danger)"></div></div>
            <button class="btn-action" onclick="toggle('dPay-${i}')">Step 2: Add Payment</button>
            <button class="btn-action" onclick="toggle('dEdit-${i}')">Edit</button>
            <button class="btn-delete" onclick="deleteItem('debts', ${i})">&times;</button>
            
            <div id="dPay-${i}" class="panel">
              <input type="number" id="dAmt-${i}" placeholder="Payment Amount">
              <input type="date" id="dDate-${i}"><input type="text" id="dNote-${i}" placeholder="Note">
              <button class="btn-main" onclick="submitUpdate('debts', ${i})" style="background:var(--danger)">Submit Payment</button>
            </div>

            <div id="dEdit-${i}" class="panel">
              <label>Total Owed:</label><input type="number" id="editTotal-${i}" value="${d.total}">
              <label>Due Date:</label><input type="date" id="editDate-${i}" value="${d.dueDate}">
              <button class="btn-main" onclick="editDebtInfo(${i})">Save Changes</button>
            </div>
          </div>`;
      });

      // Update Chart with current debt data
      updateDebtChart(data.debts);

      data.history.forEach(h => { lList.innerHTML += `<div class="log-entry"><span><b>${h.name}</b>: $${h.amount.toLocaleString()}<br><small>${h.date} ${h.note?'| '+h.note:''}</small></span></div>`; });
      const net = ts - td;
      const nw = document.getElementById('netWorthDisplay');
      nw.innerText = (net >= 0 ? '$' : '-$') + Math.abs(net).toLocaleString();
      nw.style.color = net >= 0 ? '#81c784' : '#ff8a65';
    }
  </script>
</body>
</html>
